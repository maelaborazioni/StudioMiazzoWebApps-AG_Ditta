/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"EAF8EA85-09CD-4E2A-9634-AE491D9F2EDB",variableType:8}
 */
var _idDittaLegata = null;

/**
 * @type {Number}
 * 
 * @properties={typeid:35,uuid:"BCA6E9A2-A99B-4899-B06F-93EE1D691890",variableType:8}
 */
var _idDitta = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"0757ABE2-CC51-4AE1-93AD-EB6B494DD9EB",variableType:4}
 */
var _tipologiaDitta = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"35E0E229-2F92-46BA-B946-80A839376323",variableType:4}
 */
var _tipoEsterni = 0;

/**
 * @type {Number}
 * 
 * @properties={typeid:35,uuid:"0F67957E-E9D5-4861-99B2-F6F39F6D6825",variableType:8}
 */
var _codiceLegata = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"8FC3D7DB-E940-4543-BFD2-13453332B9A2"}
 */
var _ragioneSocialeLegata = null;

/**
 * @type {Number}
 * 
 * @properties={typeid:35,uuid:"543A2BAD-BDC4-4F86-AD31-8F81643782DF",variableType:8}
 */
var _codice = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"1D26848B-58BD-4683-979A-B9CF39549958"}
 */
var _ragioneSociale = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"FA51E579-E91E-45CB-AE3E-E6067374CA4D"}
 */
var _codTipoSoggetto = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"FF97263D-34FD-4BC0-8A9B-00CB419F45B2"}
 */
var _descTipoSoggetto = '';

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"5E5FF0A0-928A-4057-B314-A124F12E2BB6"}
 */
var _codNaturaGiuridica = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"24C3823B-DC7C-4B21-96B5-C7D49229B833"}
 */
var _descNaturaGiuridica = '';

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"F48C8F2E-C36E-49EC-ACC1-C280A8CFBD37"}
 */
var _partitaIVA = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"10690179-382C-4CD3-88D0-41AB1F567713"}
 */
var _codiceFiscale = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"EEB715F8-C57B-43A4-B1F0-9F6A91A40F16"}
 */
var _indirizzoSedeLegale = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"48FD817D-BF98-44A3-BB7B-8AE0FFCFE097"}
 */
var _codComuneSedeLegale = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"EA32B142-E0BB-4495-BB5B-4A27DEAFEF6A"}
 */
var _comuneSedeLegale = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"B7C0E0F1-D589-4C23-8B32-CC6B7F963988"}
 */
var _provSedeLegale = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"A16F430C-6519-4611-A55F-AF107DC3B31F"}
 */
var _capSedeLegale = null;

/**
 * @type {Date}
 * 
 * @properties={typeid:35,uuid:"9E1FE9D3-B6C7-4294-BE2A-E716BBEE563D",variableType:93}
 */
var _inizioGestione = null;

/**
 * @type {Date}
 * 
 * @properties={typeid:35,uuid:"C556D9CE-BA05-47C4-9139-DBDC9556D88A",variableType:93}
 */
var _fineGestione = null;

/**
 * @type {Number}
 * 
 * @properties={typeid:35,uuid:"038AD8CC-7F02-483B-94BE-7BAA935F2B5D",variableType:8}
 */
var _periodoInizioGestione = null;

/**
 * @type {Number}
 * 
 * @properties={typeid:35,uuid:"A73DCC26-D2FA-4229-A24A-8E849FE523FC",variableType:8}
 */
var _periodoFineGestione = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"B1C97F78-1B3D-4FD8-93B7-AC6684D0D313",variableType:4}
 */
var _usaTracciato = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"F2B1679D-BB94-47EF-BC5F-51412D57D09E",variableType:4}
 */
var _gestioneOrologio = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"09345FD5-7122-42D8-9A93-EF066F9196FD",variableType:4}
 */
var _gestioneGGSucc = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"7E8CABD6-CEB5-4D09-AEAB-E4EDD19FC578",variableType:4}
 */
var _gestioneTurnisti = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"E68BB522-DC27-451C-BFD1-E52B8BFB930C",variableType:4}
 */
var _usaMensa = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"8969BAC7-6B3C-474A-8386-16C8F7B8638C",variableType:4}
 */
var _mesePrecedente = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"E87A14B9-86A2-4C05-893F-B5F1201A4556",variableType:4}
 */
var _gestioneRatei = 0;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"5B86DEA5-073C-4814-83A4-964C428ADB3A"}
 */
var _indirizzoAggiuntivo = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"231B172B-37F0-466F-9A73-C17281A1701B"}
 */
var _codComuneAggiuntivo = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"853C486D-6314-48D0-9FC7-A1E825EE36EC"}
 */
var _comuneAggiuntivo = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"07C71C34-A13D-4968-A0DF-502D1D02047C"}
 */
var _provAggiuntivo = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"821BB139-42AE-4B41-B073-3394AF18B132"}
 */
var _capAggiuntivo = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"FD627FF9-184B-4F05-ADFA-064257C920B3"}
 */
var _telefonoAggiuntivo = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"672AA0CA-92D8-4D36-9AE6-CB3CD0A5862F"}
 */
var _faxAggiuntivo = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"B40921E5-AF5E-4A38-A78F-1FEAED60A7EE"}
 */
var _mailAggiuntivo = null;

/**
 * @properties={typeid:24,uuid:"75D9B517-DD60-4D27-88DE-47680BB7449D"}
 */
function inizializzaCampi()
{
	_idDittaLegata = null;
    _idDitta = null;
    _tipologiaDitta = 0;
	_tipoEsterni = 0;
	_codiceLegata = null;
	_ragioneSocialeLegata = null;
	_codice = null;
	_ragioneSociale = null;
	_codTipoSoggetto = null;
	_descTipoSoggetto = '';
	_codNaturaGiuridica = null;
	_descNaturaGiuridica = '';
	_partitaIVA = null;
	_codiceFiscale = null;
	_indirizzoSedeLegale = null;
	_codComuneSedeLegale = null;
	_comuneSedeLegale = null;
	_provSedeLegale = null;
	_capSedeLegale = null;
	_inizioGestione = null;
	_fineGestione = null;
	_periodoInizioGestione = null;
	_periodoFineGestione = null;
	_usaTracciato = 0;
	_gestioneOrologio = 0;
	_gestioneGGSucc = 0;
	_gestioneTurnisti = 0;
	_usaMensa = 0;
	_mesePrecedente = 0;
	_gestioneRatei = 0;
	_indirizzoAggiuntivo = null;
	_codComuneAggiuntivo = null;
	_comuneAggiuntivo = null;
	_provAggiuntivo = null;
	_capAggiuntivo = null;
	_telefonoAggiuntivo = null;
	_faxAggiuntivo = null;
	_mailAggiuntivo = null;
}

/**
 * @param {JSRecord} _rec
 * 
 * @properties={typeid:24,uuid:"1975F03B-9B42-4F42-B902-5034150E4AF1"}
 * @AllowToRunInFind
 */
function AggiornaSelezioneDittaLegata(_rec) 
{	
	_idDittaLegata = _rec['idditta'];
	_codiceLegata = _rec['codice'];
	_ragioneSocialeLegata = _rec['ragionesociale'];		
}

/**
 * Handle changed data.
 *
 * @param oldValue old value
 * @param newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @properties={typeid:24,uuid:"4C2E018B-9BBA-4943-A94F-569EB4F28879"}
 * @AllowToRunInFind
 */
function onDataChangeDitta(oldValue, newValue, event) {
	
	_ragioneSocialeLegata = ''
	
	/** @type {JSFoundSet<db:/ma_anagrafiche/lavoratori>} */
	var _foundset = databaseManager.getFoundSet(globals.Server.MA_ANAGRAFICHE,globals.Table.DITTE);		
	var arrDitteEpi = globals.getDitteGestiteEpi2();
	_foundset.addFoundSetFilterParam('idditta','IN',arrDitteEpi);_foundset.addFoundSetFilterParam('codice', '=', newValue)
	_foundset.loadAllRecords()
	
	if (_foundset.getSize() == 1) 
	{		
		//aggiorniamo la parte di selezione ditta
		_idDitta = _foundset['idditta']
		_ragioneSociale = _foundset['ragionesociale']
		
	}
	else
		globals.svy_nav_showLookupWindow(event, '_idditta', 'LEAF_Lkp_Ditte', 'AggiornaSelezioneDitta', 'filterDitta', null, null, '', true)
		
	return true;
}

/**
 * Salva la nuova anagrafica ditta ed i dati inseriti per la gestione presenze 
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @private
 *
 * @properties={typeid:24,uuid:"274C71CE-1E26-4707-B8CB-DB9C48C2A968"}
 */
function confermaNuovaDitta(event) {
	
  try
  {
     if(validaDatiDitta())
     {
    	databaseManager.setAutoSave(false);
    	databaseManager.startTransaction();
    	
    	// crea l'anagrafica ditta    
    	/** @type {JSFoundSet<db:/ma_anagrafiche/ditte>} */	
    	var fs = databaseManager.getFoundSet(globals.Server.MA_ANAGRAFICHE,globals.Table.DITTE);
    	
    	/** @type {JSRecord<db:/ma_anagrafiche/ditte>} */
    	var newDitta = fs.getRecord(fs.newRecord());
    	if(!newDitta)
    		throw new Error('Errore durante la creazione della ditta');
    	
    	newDitta.codice = _codice;
    	newDitta.ragionesociale = _ragioneSociale;
    	newDitta.tipologia = globals.Tipologia.GESTITA_UTENTE; 
    	 
    	if(_codTipoSoggetto)
    		newDitta.codtiposoggetto = _codTipoSoggetto;
    	if(_codNaturaGiuridica)
    		newDitta.codnaturagiuridica = _codNaturaGiuridica;
    	if(_partitaIVA)
    		newDitta.partitaiva = _partitaIVA;
    	if(_codiceFiscale)
    		newDitta.codicefiscale = _codiceFiscale;
    	
    	/** @type {JSRecord<db:/ma_anagrafiche/ditte_indirizzi>} */
    	var newDittaIndirizzo = newDitta.ditte_to_ditte_indirizzi.getRecord(newDitta.ditte_to_ditte_indirizzi.newRecord());
    	if(!newDittaIndirizzo)
    		throw new Error('Errore durante la creazione dell\'indirizzo della nuova anagrafica');
    	newDittaIndirizzo.indirizzo = _indirizzoSedeLegale;
    	newDittaIndirizzo.codtipoindirizzo = globals.TipiIndirizzoDitta.SEDE_LEGALE;
    	newDittaIndirizzo.descrizione = 'Sede legale';
    	newDittaIndirizzo.codcomune = _codComuneSedeLegale;
    	newDittaIndirizzo.cap = _capSedeLegale;
    	newDittaIndirizzo.codstatoestero = '1';
    	
    	var _dataRilevazione = new Date();
    	newDittaIndirizzo.datarilevazione = _dataRilevazione;
    	
    	// TODO tipologia ditta...
	    
    	// crea il record in ditte_presenze per la gestione con EpiWeb
    	/** @type {JSRecord<db:/ma_anagrafiche/ditte_presenze>} */
    	var newDittaGestEpiWeb = newDitta.ditte_to_ditte_presenze.getRecord(newDitta.ditte_to_ditte_presenze.newRecord());	   
    	
    	if(!newDittaGestEpiWeb)
    	   throw new Error('Errore durante la creazione del record relativo alle presenze');
    	
    	newDittaGestEpiWeb.ore_gestioneepi2 = 1;
    	newDittaGestEpiWeb.ore_iniziogestione = _periodoInizioGestione;
    	newDittaGestEpiWeb.ore_finegestione = _periodoFineGestione;
    	newDittaGestEpiWeb.ore_gestionemp = _mesePrecedente;
    	newDittaGestEpiWeb.ore_gestioneturno = _gestioneTurnisti;
    	newDittaGestEpiWeb.ore_utilizzatracciato = _usaTracciato;
    	newDittaGestEpiWeb.timbrature_gestioneorologio = _gestioneOrologio;
    	newDittaGestEpiWeb.timbrature_ggsuccessivo = _gestioneGGSucc;
    	
    	
    	var success = databaseManager.commitTransaction();
    	if(!success)
	    {
	 	   var failedRecords = databaseManager.getFailedRecords();
 		   if (failedRecords && failedRecords.length > 0)
				   throw new Error('Errore durante la creazione della ditta : ' + failedRecords[0].exception.getMessage());
	    }
    	
	    if(_indirizzoAggiuntivo != '' || _codComuneAggiuntivo != '')
	    {
	    	databaseManager.startTransaction();
	    	
	    	// gestiamolo momentaneamente come un indirizzo di tipo UNITA' OPERATIVA
	    	/** @type {JSRecord<db:/ma_anagrafiche/ditte_indirizzi>} */
	    	var newDittaIndirizzoAgg = newDitta.ditte_to_ditte_indirizzi.getRecord(newDitta.ditte_to_ditte_indirizzi.newRecord());
	    	if(!newDittaIndirizzoAgg)
	    		throw new Error('Errore durante la creazione dell\'indirizzo della nuova anagrafica');
	    	newDittaIndirizzoAgg.indirizzo = _indirizzoAggiuntivo;
	    	newDittaIndirizzoAgg.codtipoindirizzo = globals.TipiIndirizzoDitta.UNITA_OPERATIVA;
	    	newDittaIndirizzoAgg.descrizione = 'Unità operativa';
	    	newDittaIndirizzoAgg.codcomune = _codComuneAggiuntivo;
	    	newDittaIndirizzoAgg.cap = _capAggiuntivo;
	    	newDittaIndirizzoAgg.codstatoestero = '1';
	    	newDittaIndirizzoAgg.datarilevazione = _dataRilevazione;
	    	
	    	success = databaseManager.commitTransaction();
	    	if(!success)
		    {
		 	   var failedRecordsEst = databaseManager.getFailedRecords();
	 		   if (failedRecordsEst && failedRecordsEst.length > 0)
					   throw new Error('Errore durante il salvataggio dell\indirizzo della ditta : ' + failedRecordsEst[0].exception.getMessage());
		    }
	    }   
	    	    
    	databaseManager.refreshRecordFromDatabase(fs,-1);
    	globals.lookupFoundset(newDitta.idditta,forms.agd_header_dtl.foundset);
    	globals.ma_utl_setStatus(globals.Status.BROWSE,controller.getName());
    	globals.svy_mod_closeForm(event);
    	
      }
      else
    	globals.ma_utl_showWarningDialog('Controlla i dati inseriti prima di proseguire','Inserisci ditta ');
	}
	catch(ex)
	{
		application.output(ex.message, LOGGINGLEVEL.ERROR);
		databaseManager.rollbackTransaction();
		globals.ma_utl_setStatus(globals.Status.BROWSE,controller.getName());
    	globals.svy_mod_closeForm(event);
		globals.ma_utl_showErrorDialog('Inserimento nuova ditta non riuscito. Contattare lo studio');
	}
	finally
	{
		databaseManager.setAutoSave(false);
	}
	
}

/**
 * @return Boolean
 * 
 * @properties={typeid:24,uuid:"6AADD5A5-FD9E-45ED-B27D-C4A9F8E83CE8"}
 */
function validaDatiDitta()
{
    if(!_codice)
    {
    	setStatusWarning('Specificare un codice numerico per identificare la nuova ditta',null,1000);
    	return false;
    }
    if(_ragioneSociale == null || _ragioneSociale == '')
    {
    	setStatusWarning('Specificare un nome per la nuova ditta',null,1000);
    	return false;
    }
    if(!globals.isCodiceDittaDisponibile(_codice))
    {
    	setStatusWarning('Esiste già una ditta con il codice scelto, specificarne un altro',null, 1000);
    	return false;
    }
    if(_tipoEsterni == 1 && _idDittaLegata == null)
    {
    	setStatusWarning('Specificare la ditta principale a cui la nuova ditta è legata',null, 1000);
    	return false;
    }
    
	return true;
}

/** 
 * @param _firstShow
 * @param _event
 *
 * @properties={typeid:24,uuid:"DA405B96-A47F-42BF-B392-1C033D8C245D"}
 */
function onShowForm(_firstShow, _event) {
	
	_super.onShowForm(_firstShow, _event);
	inizializzaCampi();
	globals.ma_utl_setStatus(globals.Status.EDIT,controller.getName());
	
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @private
 *
 * @properties={typeid:24,uuid:"B5BE46E7-0D9C-4A67-A5E0-D205513CE0CC"}
 */
function annullaInserimentoDitta(event) 
{
	databaseManager.rollbackTransaction();
	globals.ma_utl_setStatus(globals.Status.BROWSE,controller.getName());
	globals.svy_mod_closeForm(event);
}

/**
 * @param _rec
 *
 * @properties={typeid:24,uuid:"888B6B1D-9446-4731-92D1-3D7AA97CA20E"}
 */
function updateTipoSoggetto(_rec)
{
	_codTipoSoggetto = _rec['codice'];
	_descTipoSoggetto = _rec['descrizione'];
}

/**
 * @param _rec
 *
 * @properties={typeid:24,uuid:"7D2BDEDC-34BF-488D-9FED-354953CA1512"}
 */
function updateNaturaGiuridica(_rec)
{
	_codNaturaGiuridica = _rec['codice'];
	_descNaturaGiuridica = _rec['descrizione'];
}

/**
 * @param _rec
 *
 * @properties={typeid:24,uuid:"3FE317BD-78ED-4938-BE50-D95C46AF8A65"}
 */
function updateComuneSl(_rec)
{
	_codComuneSedeLegale = _rec['codcomune'];
	_comuneSedeLegale = _rec['descrizione'];
	_provSedeLegale = _rec['provincia'];
	_capSedeLegale = _rec['cap'];
}

/**
 * @param _rec
 *
 * @properties={typeid:24,uuid:"7DBBF7A5-0ADA-48DA-8B57-00D1FB589FDB"}
 */
function updateComuneAgg(_rec)
{
	_codComuneAggiuntivo = _rec['codcomune'];
	_comuneAggiuntivo = _rec['descrizione'];
	_provAggiuntivo = _rec['provincia'];
	_capAggiuntivo = _rec['cap'];
}

/**
 *
 * @param {JSEvent} event
 *
 * @properties={typeid:24,uuid:"15FD1DDB-ABB8-4FD2-995A-D5A2F6913586"}
 */
function onHide(event) {
	annullaInserimentoDitta(event);
}
